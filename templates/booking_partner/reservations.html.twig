{% extends 'base.html.twig' %}

{% block title %}Reservas - {{ booking.nombre ?: 'Servicio' }}{% endblock %}

{% block body %}
    <div class="container py-5">
        {% include 'booking_partner/_navigation.html.twig' with {navigation: navigation|default({})} %}
        {% set timezone = 'America/Argentina/Buenos_Aires' %}
        <div class="mb-3">
            <a class="text-decoration-none" href="{{ path('app_booking_partner') }}">
                <i class="bi bi-arrow-left"></i> Volver al listado de servicios
            </a>
        </div>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
            <div>
                <h1 class="h3 mb-1">Reservas de {{ booking.nombre ?: 'Servicio sin título' }}</h1>
                <p class="text-muted mb-0">Controlá el estado de las reservas y descargá reportes en PDF.</p>
            </div>
            <div class="d-flex gap-3">
                <div class="text-center">
                    <div class="fw-semibold fs-4">{{ reservas.pendientes|length }}</div>
                    <div class="text-muted small">Pendientes</div>
                </div>
                <div class="text-center">
                    <div class="fw-semibold fs-4 text-success">{{ reservas.pagadas|length }}</div>
                    <div class="text-muted small">Confirmadas</div>
                </div>
                <div class="text-center">
                    <div class="fw-semibold fs-4 text-secondary">{{ reservas.canceladas|length }}</div>
                    <div class="text-muted small">Canceladas</div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-sm-6 col-md-4">
                        <label for="ff" class="form-label">Filtrar por fecha de salida</label>
                        <select id="ff" name="ff" class="form-select" onchange="this.form.submit()">
                            <option value="">Todas las fechas</option>
                            {% set fechas = booking.getFechasdelservicioArray ?? [] %}
                            {% for fecha in fechas %}
                                {% set value = fecha.fecha ? fecha.fecha|date('d-m-Y H:i', 'America/Argentina/Buenos_Aires') : '' %}
                                <option value="{{ value }}" {% if value and value == fechaFiltro %}selected{% endif %}>
                                    {{ fecha.fecha ? fecha.fecha|date('d/m/Y H:i', 'America/Argentina/Buenos_Aires') : 'Sin fecha asignada' }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% if fechaFiltro %}
                        <div class="col-auto">
                            <a class="btn btn-outline-secondary" href="{{ path('app_booking_partner_service_reservations', {id: booking.id}) }}">Quitar filtro</a>
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>

        {% set estados = {
            'pendientes': {'titulo': 'Pendientes', 'descripcion': 'Reservas que aún no confirmaste.' , 'color': 'warning', 'estadoId': 1},
            'pagadas': {'titulo': 'Confirmadas', 'descripcion': 'Reservas abonadas listas para operar.', 'color': 'success', 'estadoId': 2},
            'canceladas': {'titulo': 'Canceladas', 'descripcion': 'Reservas que fueron anuladas.', 'color': 'secondary', 'estadoId': 3}
        } %}

        {% for clave, config in estados %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-{{ config.color }} bg-opacity-10 d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                    <div>
                        <h2 class="h5 mb-1 text-{{ config.color }}">{{ config.titulo }}</h2>
                        <p class="text-muted mb-0">{{ config.descripcion }}</p>
                    </div>
                    <a class="btn btn-outline-{{ config.color }} btn-sm" href="{{ path('app_booking_partner_pdf', {id: booking.id, estadoId: config.estadoId, ff: fechaFiltro}) }}" target="_blank">
                        <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
                    </a>
                </div>
                <div class="card-body p-0">
                    {% set listado = attribute(reservas, clave) %}
                    {% if listado is empty %}
                        <div class="p-4 text-center text-muted">No hay reservas {{ config.titulo|lower }} para mostrar.</div>
                    {% else %}
                        <div class="accordion accordion-flush" id="accordion-{{ clave }}">
                            {% for reserva in listado %}
                                {% set collapseId = 'reserva-' ~ clave ~ '-' ~ reserva.id %}
                                {% set companions = reserva.getInChargeOfArray ?? [] %}
                                {% set additional = reserva.getFormRequiredArray ?? [] %}
                                {% set pagosMp = reserva.pagosMercadoPago %}
                                {% set pagosPaypal = reserva.pagosPayPal %}
                                {% set estadoNombre = reserva.estado ? (reserva.estado.getnombreporlenguaje(idiomaPlataforma.codigo).traduccion ?? config.titulo) : config.titulo %}
                                <div class="accordion-item">
                                    <h3 class="accordion-header" id="heading-{{ collapseId }}">
                                        <button class="accordion-button collapsed py-3" type="button" data-bs-toggle="collapse" data-bs-target="#{{ collapseId }}" aria-expanded="false" aria-controls="{{ collapseId }}">
                                            <div class="container-fluid px-0">
                                                <div class="row align-items-center g-0 w-100">
                                                    <div class="col-12 col-lg-4">
                                                        <div class="d-flex flex-column">
                                                            <span class="fw-semibold">#{{ reserva.id }} · {{ reserva.name }} {{ reserva.surname }}</span>
                                                            <span class="small text-muted">{{ reserva.email }}</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 col-lg-2 text-lg-center mt-2 mt-lg-0">
                                                        <div class="fw-semibold"><i class="bi bi-people-fill me-1"></i>{{ companions|length + 1 }}</div>
                                                        <div class="small text-muted">Pasajeros</div>
                                                    </div>
                                                    <div class="col-6 col-lg-3 text-lg-center mt-2 mt-lg-0">
                                                        <div class="fw-semibold">
                                                            {% if reserva.fechaSeleccionada %}
                                                                {{ reserva.fechaSeleccionada|date('d/m/Y H:i', timezone) }}
                                                            {% else %}
                                                                <span class="text-muted">Sin fecha</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="small text-muted">Servicio</div>
                                                    </div>
                                                    <div class="col-12 col-lg-3 text-lg-end mt-2 mt-lg-0">
                                                        <div class="fw-semibold">{{ reserva.updatedAt|date('d/m/Y H:i', timezone) }}</div>
                                                        <div class="small text-muted">Actualizado</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </button>
                                    </h3>
                                    <div id="{{ collapseId }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ collapseId }}">
                                        <div class="accordion-body bg-light">
                                            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
                                                <div>
                                                    <span class="badge text-bg-{{ config.color }} text-uppercase">{{ estadoNombre }}</span>
                                                    <div class="small text-muted mt-2">
                                                        Creada el {{ reserva.createdAt|date('d/m/Y H:i', timezone) }}
                                                        {% if reserva.fechaSeleccionada %}
                                                            · Servicio {{ reserva.fechaSeleccionada|date('d/m/Y H:i', timezone) }}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="d-flex flex-wrap gap-2">
                                                    <a class="btn btn-sm btn-outline-primary" href="mailto:{{ reserva.email }}">
                                                        <i class="bi bi-envelope"></i> Enviar correo
                                                    </a>
                                                    {% if reserva.phone %}
                                                        <a class="btn btn-sm btn-outline-success" href="https://wa.me/{{ reserva.phone }}" target="_blank" rel="noopener">
                                                            <i class="bi bi-whatsapp"></i> WhatsApp
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <div class="border rounded p-3 h-100 bg-white">
                                                        <h3 class="h6 text-uppercase text-muted mb-2">Contacto principal</h3>
                                                        <p class="mb-1 fw-semibold">{{ reserva.name }} {{ reserva.surname }}</p>
                                                        <p class="mb-1"><a href="mailto:{{ reserva.email }}" class="text-decoration-none">{{ reserva.email }}</a></p>
                                                        {% if reserva.phone %}
                                                            <p class="mb-1"><a href="https://wa.me/{{ reserva.phone }}" class="text-decoration-none" target="_blank" rel="noopener">{{ reserva.phone }}</a></p>
                                                        {% endif %}
                                                        {% if reserva.idiomaPreferido %}
                                                            <p class="mb-0 small text-muted">Idioma preferido: {{ reserva.idiomaPreferido.nombre }}</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="border rounded p-3 h-100 bg-white">
                                                        <h3 class="h6 text-uppercase text-muted mb-2">Datos proporcionados</h3>
                                                        {% if additional %}
                                                            <div class="row g-3">
                                                                {% for dato in additional %}
                                                                    <div class="col-sm-6 col-lg-4">
                                                                        <div class="small text-muted text-uppercase fw-semibold">{{ dato.dato }}</div>
                                                                        <div>{{ dato.value ?: '-' }}</div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        {% else %}
                                                            <p class="text-muted mb-0 small">No se registraron datos adicionales.</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>

                                            {% if companions %}
                                                <div class="border rounded p-3 bg-white mt-4">
                                                    <h3 class="h6 text-uppercase text-muted mb-3">Pasajeros adicionales</h3>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm align-middle mb-0">
                                                            <thead class="table-light">
                                                            <tr>
                                                                <th>Nombre</th>
                                                                <th>Apellido</th>
                                                                {% set companionHeaders = companions[0].form_required ?? [] %}
                                                                {% for extra in companionHeaders %}
                                                                    <th>{{ extra.dato }}</th>
                                                                {% endfor %}
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            {% for companion in companions %}
                                                                <tr>
                                                                    <td>{{ companion.name }}</td>
                                                                    <td>{{ companion.surname }}</td>
                                                                    {% for extra in companion.form_required ?? [] %}
                                                                        <td>{{ extra.value ?: '-' }}</td>
                                                                    {% endfor %}
                                                                </tr>
                                                            {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            {% endif %}

                                            {% if pagosMp|length or pagosPaypal|length %}
                                                <div class="border rounded p-3 bg-white mt-4">
                                                    <h3 class="h6 text-uppercase text-muted mb-3">Pagos registrados</h3>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm align-middle mb-0">
                                                            <thead class="table-light">
                                                            <tr>
                                                                <th>Fecha</th>
                                                                <th>Referencia</th>
                                                                <th>Estado</th>
                                                                <th>Monto</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            {% for pago in pagosMp %}
                                                                <tr>
                                                                    <td>{{ pago.updatedAt ? pago.updatedAt|date('d/m/Y H:i', timezone) : '-' }}</td>
                                                                    <td>{{ pago.paymentId }}</td>
                                                                    <td>{{ pago.status }}</td>
                                                                    <td>ARS ${{ (pago.transactionAmount - pago.transactionAmountRefunded)|number_format(2, ',', '.') }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                            {% for pago in pagosPaypal %}
                                                                <tr>
                                                                    <td>{{ pago.updatedAt ? pago.updatedAt|date('d/m/Y H:i', timezone) : '-' }}</td>
                                                                    <td>{{ pago.ordersId }}</td>
                                                                    <td>{{ pago.estado }}</td>
                                                                    <td>USD {{ pago.total|number_format(2, ',', '.') }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-white">
                    {% set resumen = attribute(personas, clave) %}
                    {% if resumen is not empty %}
                        <div class="small text-muted">Total de pasajeros por fecha:</div>
                        <ul class="small text-muted mb-0">
                            {% for dato in resumen %}
                                <li>{{ dato.fecha ? dato.fecha|date('d/m/Y H:i', 'America/Argentina/Buenos_Aires') : 'Sin fecha asignada' }} - {{ dato.solicitudes }} personas</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="small text-muted">Sin movimientos registrados.</div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}
